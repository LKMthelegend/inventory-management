import { useState, useEffect } from 'react';
import Select from 'react-select';
import axios from 'axios';
import { toast } from 'react-toastify';

export default function AddMateriel({ isVisible, onClose, addHardware }) {
  const [name, setName] = useState('');
  const [type, setType] = useState('');
  const [serialNumber, setSerialNumber] = useState('');
  const [selectedSoftware, setSelectedSoftware] = useState([]);
  const [softwareOptions, setSoftwareOptions] = useState([]);

  useEffect(() => {
    fetchAvailableSoftware();
  }, []);

  const fetchAvailableSoftware = async () => {
    try {
      const response = await axios.get('http://localhost:8080/softwares');
      const options = response.data.map((software) => ({
        value: software._id,
        label: software.name,
      }));
      setSoftwareOptions(options);
    } catch (error) {
      console.error('Erreur lors de la récupération des logiciels disponibles : ', error);
    }
  };

  const handleAddHardware = async () => {
    const formData = {
      name,
      type,
      serialNumber,
      software: selectedSoftware.map((option) => option.value),
    };

    try {
        await addHardware(formData);
    //   await new Promise((resolve) => setTimeout(resolve, 1000));
      // Réussite de l'ajout
      toast.success('Matériel ajouté avec succès');
      onClose();
    } catch (error) {
      // Échec de l'ajout
      toast.error('Erreur lors de l\'ajout du matériel');
    }
  };

  if (!isVisible) return null;

  return (
    <div className='fixed inset-0 bg-black bg-opacity-25 backdrop-blur-sm flex justify-center items-center shadow-lg'>
      <div className='w-[600px] flex flex-col'>
        <button onClick={onClose}>Fermer</button>
        <div>
          <label htmlFor='name'>Nom du matériel</label>
          <input
            id='name'
            value={name}
            onChange={(e) => setName(e.target.value)}
            type='text'
          />
        </div>
        <div>
          <label htmlFor='type'>Type</label>
          <input
            id='type'
            value={type}
            onChange={(e) => setType(e.target.value)}
            type='text'
          />
        </div>
        <div>
          <label htmlFor='serialNumber'>Numéro de série</label>
          <input
            id='serialNumber'
            value={serialNumber}
            onChange={(e) => setSerialNumber(e.target.value)}
            type='text'
          />
        </div>
        <div>
          <label htmlFor='software'>Logiciels</label>
          <Select
            id='software'
            options={softwareOptions}
            value={selectedSoftware}
            isMulti
            onChange={setSelectedSoftware}
          />
        </div>
        <button onClick={handleAddHardware}>Ajouter</button>
      </div>
    </div>
  );
}
